!function(){function e(e,t){this.imInstance=t,this.id=e.conv_id,this.type=e.conv_type,this.title=e.conv_title,this.subtitle=e.conv_subtitle,this.avatar=e.conv_avatar,this.readMsgId=e.read_msg_id,this.mTime=e.mtime,this.peer=e.peer,this.summary=e.summary,Object.defineProperty(this,"_originalObject",{value:e,enumerable:!1})}function t(e,t){this.imInstance=t,this.convId=e.msg.conv_id,this.convType=e.msg.conv_type,this.fromUcid=e.msg.from_ucid,this.id=e.msg.msg_id,this.localId=e.msg.msg_local_id,this.payload=e.msg.msg_payload,this.type=e.msg.msg_type,this.sendTime=e.msg.send_time,this.seq=e.seq,Object.defineProperty(this,"_originalObject",{value:e,enumerable:!1})}function n(){this._listener={}}function r(e){if(this._events=new n,this.appkey=e.appkey,this.msgApiRoot=e.msgApiRoot,this.mediaApiRoot=e.mediaApiRoot,this.configHeader=e.apiheader,this.ucid=e.ucid,this.convMap={},this.currentSeq=-1,this.msgTimer=0,this.msgTimerLevel=0,this.initMsgWindow={},this.triggerSyncTimer=null,this.state=0,!this.appkey)throw new Error("IM need appkey")}!function(e){"use strict";function t(e,t){var n=(65535&e)+(65535&t),r=(e>>16)+(t>>16)+(n>>16);return r<<16|65535&n}function n(e,t){return e<<t|e>>>32-t}function r(e,r,i,a,o,s){return t(n(t(t(r,e),t(a,s)),o),i)}function i(e,t,n,i,a,o,s){return r(t&n|~t&i,e,t,a,o,s)}function a(e,t,n,i,a,o,s){return r(t&i|n&~i,e,t,a,o,s)}function o(e,t,n,i,a,o,s){return r(t^n^i,e,t,a,o,s)}function s(e,t,n,i,a,o,s){return r(n^(t|~i),e,t,a,o,s)}function c(e,n){e[n>>5]|=128<<n%32,e[(n+64>>>9<<4)+14]=n;var r,c,d,h,u,l=1732584193,f=-271733879,m=-1732584194,p=271733878;for(r=0;r<e.length;r+=16)c=l,d=f,h=m,u=p,l=i(l,f,m,p,e[r],7,-680876936),p=i(p,l,f,m,e[r+1],12,-389564586),m=i(m,p,l,f,e[r+2],17,606105819),f=i(f,m,p,l,e[r+3],22,-1044525330),l=i(l,f,m,p,e[r+4],7,-176418897),p=i(p,l,f,m,e[r+5],12,1200080426),m=i(m,p,l,f,e[r+6],17,-1473231341),f=i(f,m,p,l,e[r+7],22,-45705983),l=i(l,f,m,p,e[r+8],7,1770035416),p=i(p,l,f,m,e[r+9],12,-1958414417),m=i(m,p,l,f,e[r+10],17,-42063),f=i(f,m,p,l,e[r+11],22,-1990404162),l=i(l,f,m,p,e[r+12],7,1804603682),p=i(p,l,f,m,e[r+13],12,-40341101),m=i(m,p,l,f,e[r+14],17,-1502002290),f=i(f,m,p,l,e[r+15],22,1236535329),l=a(l,f,m,p,e[r+1],5,-165796510),p=a(p,l,f,m,e[r+6],9,-1069501632),m=a(m,p,l,f,e[r+11],14,643717713),f=a(f,m,p,l,e[r],20,-373897302),l=a(l,f,m,p,e[r+5],5,-701558691),p=a(p,l,f,m,e[r+10],9,38016083),m=a(m,p,l,f,e[r+15],14,-660478335),f=a(f,m,p,l,e[r+4],20,-405537848),l=a(l,f,m,p,e[r+9],5,568446438),p=a(p,l,f,m,e[r+14],9,-1019803690),m=a(m,p,l,f,e[r+3],14,-187363961),f=a(f,m,p,l,e[r+8],20,1163531501),l=a(l,f,m,p,e[r+13],5,-1444681467),p=a(p,l,f,m,e[r+2],9,-51403784),m=a(m,p,l,f,e[r+7],14,1735328473),f=a(f,m,p,l,e[r+12],20,-1926607734),l=o(l,f,m,p,e[r+5],4,-378558),p=o(p,l,f,m,e[r+8],11,-2022574463),m=o(m,p,l,f,e[r+11],16,1839030562),f=o(f,m,p,l,e[r+14],23,-35309556),l=o(l,f,m,p,e[r+1],4,-1530992060),p=o(p,l,f,m,e[r+4],11,1272893353),m=o(m,p,l,f,e[r+7],16,-155497632),f=o(f,m,p,l,e[r+10],23,-1094730640),l=o(l,f,m,p,e[r+13],4,681279174),p=o(p,l,f,m,e[r],11,-358537222),m=o(m,p,l,f,e[r+3],16,-722521979),f=o(f,m,p,l,e[r+6],23,76029189),l=o(l,f,m,p,e[r+9],4,-640364487),p=o(p,l,f,m,e[r+12],11,-421815835),m=o(m,p,l,f,e[r+15],16,530742520),f=o(f,m,p,l,e[r+2],23,-995338651),l=s(l,f,m,p,e[r],6,-198630844),p=s(p,l,f,m,e[r+7],10,1126891415),m=s(m,p,l,f,e[r+14],15,-1416354905),f=s(f,m,p,l,e[r+5],21,-57434055),l=s(l,f,m,p,e[r+12],6,1700485571),p=s(p,l,f,m,e[r+3],10,-1894986606),m=s(m,p,l,f,e[r+10],15,-1051523),f=s(f,m,p,l,e[r+1],21,-2054922799),l=s(l,f,m,p,e[r+8],6,1873313359),p=s(p,l,f,m,e[r+15],10,-30611744),m=s(m,p,l,f,e[r+6],15,-1560198380),f=s(f,m,p,l,e[r+13],21,1309151649),l=s(l,f,m,p,e[r+4],6,-145523070),p=s(p,l,f,m,e[r+11],10,-1120210379),m=s(m,p,l,f,e[r+2],15,718787259),f=s(f,m,p,l,e[r+9],21,-343485551),l=t(l,c),f=t(f,d),m=t(m,h),p=t(p,u);return[l,f,m,p]}function d(e){var t,n="",r=32*e.length;for(t=0;r>t;t+=8)n+=String.fromCharCode(e[t>>5]>>>t%32&255);return n}function h(e){var t,n=[];for(n[(e.length>>2)-1]=void 0,t=0;t<n.length;t+=1)n[t]=0;var r=8*e.length;for(t=0;r>t;t+=8)n[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return n}function u(e){return d(c(h(e),8*e.length))}function l(e,t){var n,r,i=h(e),a=[],o=[];for(a[15]=o[15]=void 0,i.length>16&&(i=c(i,8*e.length)),n=0;16>n;n+=1)a[n]=909522486^i[n],o[n]=1549556828^i[n];return r=c(a.concat(h(t)),512+8*t.length),d(c(o.concat(r),640))}function f(e){var t,n,r="0123456789abcdef",i="";for(n=0;n<e.length;n+=1)t=e.charCodeAt(n),i+=r.charAt(t>>>4&15)+r.charAt(15&t);return i}function m(e){return unescape(encodeURIComponent(e))}function p(e){return u(m(e))}function g(e){return f(p(e))}function v(e,t){return l(m(e),m(t))}function w(e,t){return f(v(e,t))}function y(e,t,n){return t?n?v(t,e):w(t,e):n?p(e):g(e)}e.md5=y}(this);var i={timeOffset:0,noop:function(){},makeRequestHeader:function(e,t,n){function r(e){var t=[];return $.each(e,function(e,n){t.push(e+"="+n)}),t.sort(),t.join("&")}var i={},a={},o="";return a=$.extend({"Lianjia-Access-Token":"1","Lianjia-Device-Id":"","Lianjia-Im-Timestamp":(new Date).getTime()-this.timeOffset},e),i=$.extend(i,a),i=$.extend(i,t),delete i["Lianjia-Uuid"],o=r(i),a["Lianjia-Im-Signature"]=md5(o+n),a}};e.prototype={constructor:e,fetchDetail:function(e){var t=this;e=e||i.noop;var n={conv_id:this.id};$.ajax({url:this.imInstance.msgApiRoot+"/conv/detail/fetch",headers:i.makeRequestHeader(this.imInstance.configHeader,n,this.imInstance.appkey),data:n,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(n){if(0!==n.errno)throw e(null,t),new Error(n.error);e(n.data,t)},error:function(){throw e(null,t),new Error("/conv/detail/fetch ajax fail.")}})},updateDetail:function(){var e=this;({conv_id:this.id});this.fetchDetail(function(t){e.id=t.conv_id,e.type=t.conv_type,e.title=t.conv_title,e.subtitle=t.conv_subtitle,e.avatar=t.conv_avatar,e.readMsgId=t.read_msg_id,e.mTime=t.mtime,e.peer=t.peer,e.summary=t.summary})}},t.prototype={constructor:t},n.prototype={constructor:n,addListener:function(e,t){"undefined"==typeof this._listener[e]&&(this._listener[e]=[]),"function"==typeof t&&this._listener[e].push(t)},removeListener:function(e,t){var n=this._listener[e];if("function"==typeof t)for(var r=0,i=n.length;r<i;r++)t===n[r]&&n.splice(r,1);else"undefined"==typeof t&&delete this._listener[e]},fireEvent:function(e,t,n){var r=this._listener[e],i=[{type:e,target:n,param:t}];if(r)for(var a=0,o=r.length;a<o;a++)"function"==typeof r[a]&&(t instanceof Array&&(i=i.concat(t)),r[a].apply(this,i))}},r.prototype={constructor:r,initialize:function(){function e(){$.ajax({url:n.msgApiRoot+"/config/sync",headers:i.makeRequestHeader(n.configHeader,{},n.appkey),data:{},dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw t(),new Error(e.error);t(e.data.poll.windows)},error:function(){throw t(),new Error("/config/sync ajax fail.")}})}function t(e){n.initMsgWindow=e||[{interval:3,count:10},{interval:6,count:10},{interval:15,count:8},{interval:30,count:4},{interval:60,count:-1}],n.syncConv(0,100,function(e){n.state=1,n.fire("init",[n]),n.triggerSyncMsg(n.currentSeq)})}var n=this;$.ajax({url:this.msgApiRoot+"/time/sync",headers:i.makeRequestHeader(this.configHeader,{},this.appkey),data:{},dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(t){if(0!==t.errno)throw i.timeOffset=0,e(),new Error(t.error);i.timeOffset=Math.round(+new Date-t.data.timestamp),e()},error:function(){throw i.timeOffset=0,e(),new Error("/time/sync ajax fail.")}})},syncConv:function(t,n,r){function a(t,n,r){var a=arguments.callee,s={offset:t,limit:n};$.ajax({url:o.msgApiRoot+"/user/conv/list",headers:i.makeRequestHeader(o.configHeader,s,o.appkey),data:s,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(i){if(0!==i.errno)throw r(null,o),new Error(i.error);$.each(i.data.list,function(){o.convMap[this.conv_id]=new e(this,o)}),t+i.data.list.length<i.data.total_count&&i.data.list.length>0?a(t+n,n,r):r(o.convMap,o)},error:function(){throw r(null,o),new Error("/user/conv/list ajax fail.")}})}var o=this;r=r||i.noop,a(t,n,r)},syncMsg:function(n){function r(n){clearTimeout(a.msgTimer);var r={},s=arguments.callee;n===-1?(r.rev_seq=n,r.seq=0):r.seq=n;$.ajax({url:a.msgApiRoot+"/msg/sync",headers:i.makeRequestHeader(a.configHeader,r,a.appkey),data:r,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},timeout:1e4,cache:!0,success:function(r){if(0!==r.errno)throw a.msgTimer=setTimeout(function(){s(a.currentSeq)},1e3*a.initMsgWindow[a.msgTimerLevel].interval),new Error(r.error);if(r.data.list.length>0){a.currentSeq=r.data.list[r.data.list.length-1].seq;var i=[],c=[],d=[];$.each(r.data.list,function(){var n=new t(this,a);switch(a.convMap[n.convId]||0===n.convId||(a.convMap[n.convId]={},a.fetchConversation(n.convId,function(t){a.convMap[n.convId]=new e(t,a)})),n.type){case 100:c.push(n);break;case 101:d.push(n);break;default:i.push(n)}}),i.length>0&&a.fire("message",[i,n]),c.length>0&&a.fire("arrive",[c,n]),d.length>0&&a.fire("read",[d,n]),o=0,a.msgTimerLevel=0}1===r.data.has_more?s(a.currentSeq):(a.initMsgWindow[a.msgTimerLevel].count===-1?o=0:o>=a.initMsgWindow[a.msgTimerLevel].count&&(o=0,a.msgTimerLevel=Math.min(a.msgTimerLevel+1,a.initMsgWindow.length-1)),o++,a.msgTimer=setTimeout(function(){s(a.currentSeq)},1e3*a.initMsgWindow[a.msgTimerLevel].interval)),n===-1&&a.fire("start",[a])},error:function(){throw a.msgTimer=setTimeout(function(){s(a.currentSeq)},1e3*a.initMsgWindow[a.msgTimerLevel].interval),new Error("/msg/sync ajax fail.")}})}var a=this;this.msgTimerLevel=0;var o=0;r(n)},triggerSyncMsg:function(e){var t=this;this.triggerSyncTimer&&clearTimeout(this.triggerSyncTimer),this.triggerSyncTimer=setTimeout(function(){t.syncMsg(e)},100)},create:function(t,n,r){var a=this,o="",s={};if(r=r||i.noop,1===n){if(t instanceof Array){if(t.length>1)throw new Error("Error #42002: conv_type === 1 only allow 2 members. Please see http://wiki.lianjia.com/pages/viewpage.action?pageId=9899018 .");o=t.join(",")}else o=t;if(o===this.ucid)throw new Error("Error #42003: conv_type === 1 can't talk to self. Please see http://wiki.lianjia.com/pages/viewpage.action?pageId=9899018 .");s={members:t,conv_type:n},$.ajax({url:a.msgApiRoot+"/conv/create",headers:i.makeRequestHeader(this.configHeader,s,this.appkey),data:s,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(t){if(0!==t.errno)throw r(null,a),new Error(t.error);var n=new e(t.data,a);a.convMap[n.id]=n,r(n,a)},error:function(){throw r(null,a),new Error("/conv/create ajax fail.")}})}else o=t.join(","),s={members:o,conv_type:n},$.ajax({url:a.msgApiRoot+"/conv/create",headers:i.makeRequestHeader(this.configHeader,s,this.appkey),data:s,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(t){if(0!==t.errno)throw r(null,a),new Error(t.error);r(new e(t.data,a))},error:function(){throw r(null,a),new Error("/conv/create ajax fail.")}})},talkTo:function(e,t,n){var r=this;n=n||i.noop,this.getTalk(e,function(i){i?r.sendTo(i.id,t,n):r.create(e,1,function(e){r.sendTo(e.id,t,n)})})},sendTo:function(e,n,r){var a=this,o={conv_id:e,msg_local_id:n.localId||+new Date,msg_type:n.type,msg_payload:n.payload};r=r||i.noop,$.ajax({url:this.msgApiRoot+"/msg/send",headers:i.makeRequestHeader(this.configHeader,o,this.appkey),data:o,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw r(null,a),new Error(e.error);var i=new t({msg:{conv_id:e.data.conv_id,from_ucid:a.ucid,msg_id:e.data.msg_id,msg_local_id:e.data.msg_local_id,msg_payload:n.payload,msg_type:n.type,send_time:e.data.send_time},seq:-1},a);r(i,a),a.triggerSyncMsg(a.currentSeq)},error:function(){throw r(null,a),new Error("/msg/send ajax fail.")}})},uploadPicture:function(e,t,n){var r=this,a=new FormData;a.append("conv_id",e),a.append("image",t),$.ajax({url:this.mediaApiRoot+"/image/upload",headers:i.makeRequestHeader(this.configHeader,{},this.appkey),data:a,dataType:"json",processData:!1,contentType:!1,method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw n(null,r),new Error(e.error);n(JSON.stringify(e.data),r)},error:function(){throw n(null,r),new Error("/image/upload ajax fail.")}})},markRead:function(e,t){var n=this,r={conv_id:e.convId,msg_id:e.id};t=t||i.noop,$.ajax({url:this.msgApiRoot+"/msg/read",headers:i.makeRequestHeader(this.configHeader,r,this.appkey),data:r,dataType:"json",method:"POST",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw t(null,n),new Error(e.error);t(e.data,n)},error:function(){throw t(null,n),new Error("/msg/read ajax fail.")}})},fetchConversation:function(e,t){var n=this,r={conv_id:e};t=t||i.noop,$.ajax({url:this.msgApiRoot+"/conv/detail/fetch",headers:i.makeRequestHeader(this.configHeader,r,this.appkey),data:r,dataType:"json",method:"GET",async:!1,xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw t(null,n),new Error(e.error);t(e.data,n)},error:function(){throw t(null,n),new Error("/conv/detail/fetch ajax fail.")}})},getTalk:function(e,t){var n=this;t=t||i.noop;var r=null;$.each(this.convMap,function(){var t=this;if(1===t.conv_type&&t.peer.ucid===e)return r=this,!1}),t(r,n)},getHistory:function(e,n){var r=this;n=n||i.noop,$.ajax({url:this.msgApiRoot+"/msg/list",headers:i.makeRequestHeader(this.configHeader,e,this.appkey),data:e,dataType:"json",method:"GET",xhrFields:{withCredentials:!0},cache:!0,success:function(e){if(0!==e.errno)throw n(null,r),new Error(e.error);var i=e.data.list,a=[];$.each(i,function(){a.push(new t({msg:this},r))}),n(a,r)},error:function(){throw n(null,r),new Error("/msg/list ajax fail.")}})},encodeHtml:function(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")},on:function(e,t){this._events.addListener(e,t)},off:function(e,t){this._events.removeListener(e,t)},fire:function(e,t){this._events.fireEvent(e,t,this)},destory:function(){this.fire("destory",[this]),clearTimeout(this.msgTimer),delete this._events._listener}},window.ImCore=r}();